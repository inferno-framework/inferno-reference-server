name: Inferno CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  INFERNO_G10_RELEASE: v6.0.0

jobs:

  test:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout server
        uses: actions/checkout@v4

      - name: Fetch latest g10 test kit
        run: git clone https://github.com/onc-healthit/onc-certification-g10-test-kit.git --branch $INFERNO_G10_RELEASE --depth 1

      # TODO: delete this when inferno execute is merged
      - name: Point test kit to experimental branch
        working-directory: ${{ github.workspace }}/onc-certification-g10-test-kit
        run: |
          echo "gem 'inferno_core', git: 'https://github.com/inferno-framework/inferno-core.git', branch: 'fi-2937-inferno-execute'" >> Gemfile
          rm Gemfile.lock # force re-install

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          working-directory: ${{ github.workspace }}/onc-certification-g10-test-kit
          bundler-cache: true

      - name: Start server
        run: |
          docker compose build
          docker compose up -d
          wget -qO- https://raw.githubusercontent.com/eficode/wait-for/v2.2.3/wait-for | sh -s -- localhost:8080 -- echo "Server ready"

      - name: Start Inferno services
        working-directory: ${{ github.workspace }}/onc-certification-g10-test-kit
        run: |
          gem install foreman
          bundle exec inferno migrate
          bundle exec inferno services start
          wget -qO- https://raw.githubusercontent.com/eficode/wait-for/v2.2.3/wait-for | sh -s -- http://localhost:80/hl7validatorapi/validator/version -- echo "Inferno services ready"

      - name: Run test kit groups from single patient api without TLS test
        working-directory: ${{ github.workspace }}/onc-certification-g10-test-kit
        env:
          INFERNO_EXEC_SUITE_OPTIONS: 'us_core_version:us_core_3 smart_app_launch_version:smart_app_launch_1 multi_patient_version:multi_patient_api_stu1'
          INFERNO_EXEC_INPUTS: '"url:localhost:8080/reference-server/r4" patient_id:85 additional_patient_ids:85,355 "smart_credentials:{\"access_token\":\"SAMPLE_TOKEN\"}"'
        run: |
          bundle exec inferno execute -t g10_certification-g10_single_patient_api-g10_patient_id_setup -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-g10_incorrectly_permitted_tls_versions_messages_setup -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -t g10_certification-g10_single_patient_api-us_core_v311_capability_statement-us_core_conformance_support -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -t g10_certification-g10_single_patient_api-us_core_v311_capability_statement-us_core_fhir_version -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -t g10_certification-g10_single_patient_api-us_core_v311_capability_statement-us_core_json_support -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -t g10_certification-g10_single_patient_api-us_core_v311_capability_statement-us_core_profile_support -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_patient -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_allergy_intolerance -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_care_plan -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_care_team -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_condition -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_device -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_diagnostic_report_note -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_diagnostic_report_lab -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_document_reference -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_goal -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_immunization -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_medication_request -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_smokingstatus -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_pediatric_weight_for_height -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_observation_lab -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_pediatric_bmi_for_age -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_pulse_oximetry -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_head_circumference -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_bodyheight -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_bodytemp -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_bp -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_bodyweight -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_heartrate -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_resprate -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_procedure -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_encounter -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_organization -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_practitioner -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_provenance -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_v311_clinical_notes_guidance -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}
          bundle exec inferno execute -g g10_certification-g10_single_patient_api-us_core_311_data_absent_reason -o ${{ env.INFERNO_EXEC_SUITE_OPTIONS }} -i ${{ env.INFERNO_EXEC_INPUTS }}


      - name: Stop server
        run: docker compose down

      - name: Stop Inferno services
        working-directory: ${{ github.workspace }}/onc-certification-g10-test-kit
        run: bundle exec inferno services stop
